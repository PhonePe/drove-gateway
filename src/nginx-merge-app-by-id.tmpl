# Generated by nixy {{datetime}}
user www-data;
worker_processes auto;

pid /var/run/nginx.pid

events {
    use epoll;
    worker_connections 2048;
    multi_accept on;
}

stream {
    {{- range $appid, $app := .MergeAppsByLabel "streamservicename"}}
    {{- if eq (index $app.Labels "internal") "stream"}}
    {{- range $id, $definition := $app.PortDefinitions}}
    {{- if ne (index $app.Labels "streamservicename") ""}}
    upstream {{ (index $app.Labels "streamservicename") }}-{{ $id }} {
    {{- else}}
    upstream {{index $app.Hosts 0}}-{{ $id }} {
    {{- end}}
        least_conn;
        {{- range $task := $app.Tasks}}
        server {{ $task.Host }}:{{ index $task.Ports $id}}{{- with index $task.Labels "weight"}} weight={{ .  }}{{- end}};
        {{- end}}
    }
    server {
        {{- if eq $definition.Protocol "tcp" }}
        listen {{ $definition.Port }};
        {{- else}}
        listen {{ $definition.Port }} {{ $definition.Protocol }};
        {{- end}}
        {{- if ne (index $app.Labels "streamservicename") ""}}
        proxy_pass {{ (index $app.Labels "streamservicename") }}-{{ $id }};
        {{- else}}
        proxy_pass {{index $app.Hosts 0}}-{{ $id }};
        {{- end}}
    }
}

